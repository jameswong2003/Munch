@page "/swipe"
@using System.Net.Http
@using System.Net.Http.Headers
@using System.Net.Http.Json
@inject IJSRuntime JS
@inject IHttpClientFactory HttpClientFactory
@inject ILogger<SwipePage> Logger
@inject NavigationManager Navigation
@inject FirestoreService Db
@inject UserService UserService
<link href="css/swipe.css" rel="stylesheet">

<div class="background">
    <div class="container">
        <div class="swiper">
            @if (businesses == null || businesses.Count < 2)
            {
                <p>Loading businesseses in local area...</p>
            }
            else
            {
                foreach (var business in displayedBusinesses)
                {
                    <div class="card" @onclick="() => SwipeBusiness(business)">
                        <img class="yelpImg img-radius" src="@business.image_url" alt="Business Image" style="max-height: 30vh;" />
                        <h4 class="user-name">@business.name</h4>
                        <p>@business.Location.FullAddress</p>
                        <p><div>Categories: @string.Join(", ", business.categories.Select(c => c.title))</div></p>
                        <p>Price: @(string.IsNullOrEmpty(business.price) ? "N/A" : business.price)</p>
                        <p>Rating: @business.rating <span>★</span> • Reviews: @(business.review_count == 0 ? "N/A" : business.review_count.ToString())</p>
                        <p>Phone: @(string.IsNullOrEmpty(business.phone) ? "N/A" : business.phone)</p>
                    </div>
                }
            }
        </div>
    </div>
</div>

@code {
    private List<Business>? businesses;
    private Business[] displayedBusinesses = new Business[2];
    private HashSet<Business> displayedSet = new HashSet<Business>();
    private int selectionCount = 0;

    protected override async Task OnInitializedAsync() {
        @* Check if user is logged in *@
        if (!UserService.IsLoggedIn) {
            Navigation.NavigateTo("/");
        }

        await FetchBusinesses();
        SetInitialBusinesses();
    }

    protected override void OnAfterRender(bool firstRender) {
        if (firstRender) {
            StateHasChanged();
        }
    }

    private async Task FetchBusinesses() {
        Logger.LogInformation("Fetching businesses...");
        try {
            var location = await JS.InvokeAsync<double[]>("getCoords");
            var httpClient = HttpClientFactory.CreateClient();
            httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", System.Environment.GetEnvironmentVariable("YELP_API_BEARER_TOKEN"));
            var response = await httpClient.GetAsync($"https://api.yelp.com/v3/businesses/search?latitude={location[1]}&longitude={location[0]}&limit=50");

            if (response.IsSuccessStatusCode) {
                var result = await response.Content.ReadFromJsonAsync<YelpResponse>();
                businesses = result?.Businesses.Select(b => {
                    b.categories = b.categories.GroupBy(c => c.title).Select(g => g.First()).ToList(); // Remove duplicate categories
                    return b;
                }).ToList();

                Logger.LogInformation($"Fetched {businesses.Count} businesses successfully.");
            } else {
                Logger.LogWarning($"Failed to fetch businesses. Status code: {response.StatusCode}");
                businesses = new List<Business>();
            }
        } catch (Exception ex) {
            Logger.LogError(ex, "An error occurred while fetching businesses.");
            businesses = new List<Business>();
        }
    }


    private void SetInitialBusinesses() {
        if (businesses != null && businesses.Count >= 2) {
            displayedBusinesses[0] = businesses[0];
            displayedBusinesses[1] = businesses[1];
            displayedSet.Add(businesses[0]);
            displayedSet.Add(businesses[1]);
        }
    }

    private void SwipeBusiness(Business selectedBusiness) {
        Logger.LogInformation($"Selected {selectedBusiness.name}");

        // Update the set of displayed businesses
        displayedSet.Add(selectedBusiness);

        // Find the index of the non-selected business and replace it
        int indexToReplace = Array.IndexOf(displayedBusinesses, selectedBusiness) == 0 ? 1 : 0;
        Business nextBusiness = FindNextBusiness(selectedBusiness);

        if (nextBusiness != null) {
            displayedBusinesses[indexToReplace] = nextBusiness;
        }

        selectionCount++;
        if (selectionCount == 5) { // After 5 selections, add to the database or handle end game
            Logger.LogInformation($"Final selection: {selectedBusiness.name}. Adding to database...");
            AddToDatabase(selectedBusiness);
            NavigateToAddCalendar(selectedBusiness);
        }
    }

    private Business FindNextBusiness(Business current) {
        foreach (var business in businesses) {
            if (!displayedSet.Contains(business)) {
                displayedSet.Add(business);
                return business;
            }
        }
        return null; 
    }

   private async void AddToDatabase(Business business) {
    var user = await Db.Get<User>(UserService.Id); // Fetches the user correctly

    // Check if the restaurant is already in the user's LikedRestaurants list
    var existingRestaurant = user.LikedRestaurants.FirstOrDefault(r => r.name == business.name && r.full_address == business.Location.FullAddress);

    if (existingRestaurant != null) {
        // If it exists, increment the count
        existingRestaurant.count++;
        Logger.LogInformation($"Incremented count for {existingRestaurant.name}. New count: {existingRestaurant.count}");
    } else {
        // If it does not exist, add it with a count of 1
        var newRestaurant = new Restaurant {
            image_url = business.image_url,
            name = business.name,
            phone = business.phone,
            rating = business.rating,
            review_count = business.review_count,
            yelp_url = business.yelp_url,
            price = business.price,
            full_address = business.Location.FullAddress,
            count = 1 // Initial count set to 1
        };
        user.LikedRestaurants.Add(newRestaurant);
        Logger.LogInformation($"Added new restaurant {newRestaurant.name} with initial count of 1.");
    }

    // Update category counts
    foreach (var category in business.categories) {
        if (user.CategoryCounts.ContainsKey(category.title)) {
            user.CategoryCounts[category.title]++;
        } else {
            user.CategoryCounts.Add(category.title, 1);
        }
        Logger.LogInformation($"Updated category count for {category.title}: {user.CategoryCounts[category.title]}");
    }

    // Save changes to the database
    await Db.AddOrUpdate<User>(user);
}


        private void NavigateToAddCalendar(Business business) {
        Logger.LogInformation("Navigating to Add to Calendar page...");
        var url = $"/add-calendar?businessName={business.name}&phone={business.phone}&rating={business.rating}&imageUrl={business.image_url}&address={business.Location.FullAddress}&categories={string.Join(", ", business.categories.Select(c => c.title))}&price={business.price}";
        Navigation.NavigateTo(url);
    }


        private class Category
    {
        public string alias { get; set; }
        public string title { get; set; }
    }

    private class Business
    {
        public string image_url { get; set; }
        public string name { get; set; }
        public string phone { get; set; }
        public double rating { get; set; }
        public int review_count { get; set; }
        public string yelp_url { get; set; }
        public string price { get; set; }
        public List<Category> categories { get; set; }
        public Location Location { get; set; }
    }


    private class Location {
        public string Address1 { get; set; }
        public string City { get; set; }
        public string State { get; set; }
        public string Zip_Code { get; set; }
        public string FullAddress => $"{Address1}, {City}, {State}, {Zip_Code}".TrimEnd(',', ' ');
    }

    private class YelpResponse {
        public List<Business> Businesses { get; set; }
    }
}
